<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
<style>
body {
    font-family: "Nunito", sans-serif;
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background-image: url('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=1834&q=80');
    background-size: cover;
    background-position: center;
    overflow-x: hidden;
}

.logout-wrapper {
    position: fixed;
    top: 18px;
    right: 18px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 100;
}

.logout-btn {
    background: #f39c12;
    color: white;
    border: none;
    border-radius: 50%;
    width: 52px;
    height: 52px;
    font-size: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.logout-btn:hover { background: #d68910; transform: scale(1.1); }
.logout-text { margin-top: 5px; font-size: 14px; font-weight: bold; color: white; opacity: 0; transform: translateY(-5px); transition: all 0.3s ease; }
.logout-wrapper:hover .logout-text { opacity: 1; transform: translateY(0); }

.container {
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 40px 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    text-align: center;
}

h2 { margin-top: 0; color: #55311c; }

.list-box {
    max-height: 200px;
    overflow-y: auto;
    margin: 15px 0;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #f9f9f9;
}

ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-start; }
ul li { background: #3498db; color: white; padding: 7px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 3px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; }
ul li:hover { transform: scale(1.05); background: #2980b9; }

input[type=email], input[type=number] {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 30px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    transition: all 0.3s ease;
}
input:focus { border-color: #8c7569; outline: none; }

button {
    display: block;
    width: 100%;
    padding: 14px;
    margin: 12px 0;
    border: none;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
button.reset { background: #e74c3c; color: white; }
button.reset:hover { background: #c0392b; transform: scale(1.05); }
button.send { background: #3498db; color: white; }
button.send:hover { background: #2980b9; transform: scale(1.05); }
button.save-location { background: #27ae60; color: white; }
button.save-location:hover { background: #1e8449; transform: scale(1.05); }

.message { margin-top: 10px; font-weight: bold; color: #333; text-align: center; word-break: break-word; }

@media (max-width: 500px) {
    .container { padding: 30px 20px; }
    button, input { font-size: 0.9rem; padding: 12px; }
    h2 { font-size: 1.4rem; }
    .logout-btn { width: 36px; height: 36px; font-size: 18px; }
    .logout-text { font-size: 12px; }
}
</style>
</head>
<body>

<div class="logout-wrapper">
  <button class="logout-btn" onclick="logout()">üö™</button>
  <span class="logout-text">Logout</span>
</div>

<div class="container" id="admin-container">
    <h2>Today's Present Students</h2>
    <p>Total Present: <span id="total">0</span></p>
    <div class="list-box"><ul id="list"></ul></div>

    <button class="reset" onclick="resetAll()">‚ö†Ô∏è Reset All Attendance</button>

    <input type="email" id="email" placeholder="Enter faculty email" />
    <button class="send" onclick="sendEmail()">üìß Send Attendance to Email</button>

    <hr style="margin: 20px 0;">

    <h2>Campus Location Settings</h2>
    <input type="number" id="latitude" placeholder="Latitude" step="0.00001"/>
    <input type="number" id="longitude" placeholder="Longitude" step="0.00001"/>
    <input type="number" id="radius" placeholder="Radius in meters" step="1"/>
    <button class="save-location" onclick="saveCampusLocation()">üíæ Save Location</button>

    <p class="message" id="msg"></p>
</div>

<script>
const token = localStorage.getItem('token');

async function load() {
    try {
        const res = await fetch('/api/admin/today', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        document.getElementById('total').innerText = data.total || 0;
        const list = document.getElementById('list');
        list.innerHTML = '';
        if (data.usns && data.usns.length > 0) {
            const sortedUsns = data.usns.sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
            sortedUsns.forEach((usn,index)=>{
                const li = document.createElement('li');
                li.textContent = `${index+1}. ${usn}`;
                list.appendChild(li);
            });
        } else list.innerHTML = 'No attendance marked today.';
    } catch(err) {
        console.error(err);
        document.getElementById('list').innerHTML = '‚ùå Error loading data';
    }

    // Load campus location
    try {
        const res = await fetch('/api/admin/campus-location', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const campus = await res.json();
        document.getElementById('latitude').value = campus.latitude || '';
        document.getElementById('longitude').value = campus.longitude || '';
        document.getElementById('radius').value = campus.radius || '';
    } catch(err){
        console.error(err);
    }
}

async function resetAll() {
    if(!confirm("‚ö†Ô∏è Are you sure? This will clear ALL students' attendance and device IDs!")) return;
    try {
        const res = await fetch('/api/admin/reset-all', {
            method:'POST',
            headers:{'Authorization':'Bearer '+token}
        });
        const data = await res.json();
        document.getElementById('msg').innerText = data.message || data.error;
        load();
    } catch(err) { console.error(err); document.getElementById('msg').innerText="‚ùå Server error"; }
}

async function sendEmail() {
    const email = document.getElementById('email').value.trim();
    if(!email){ alert("Please enter a valid email"); return; }

    try {
        const res = await fetch('/api/admin/send-email',{
            method:'POST',
            headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
            body: JSON.stringify({email})
        });
        const data = await res.json();
        document.getElementById('msg').innerText = data.message || data.error;
    } catch(err){ console.error(err); document.getElementById('msg').innerText="‚ùå Failed to send email"; }
}

async function saveCampusLocation(){
    const latitude = parseFloat(document.getElementById('latitude').value);
    const longitude = parseFloat(document.getElementById('longitude').value);
    const radius = parseFloat(document.getElementById('radius').value);

    if(isNaN(latitude)||isNaN(longitude)||isNaN(radius)){ alert("Enter valid values"); return; }

    try {
        const res = await fetch('/api/admin/campus-location',{
            method:'POST',
            headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
            body: JSON.stringify({latitude,longitude,radius})
        });
        const data = await res.json();
        document.getElementById('msg').innerText = data.message || data.error;
    } catch(err){ console.error(err); document.getElementById('msg').innerText="‚ùå Failed to save location"; }
}

function logout(){ localStorage.removeItem('token'); window.location.href="login.html"; }

document.addEventListener('DOMContentLoaded', load);
</script>

</body>
</html>
